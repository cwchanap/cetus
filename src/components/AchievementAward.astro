---
import { cn } from '@/lib/utils'
import type { HTMLAttributes } from 'astro/types'

export interface Props extends HTMLAttributes<'div'> {
  class?: string
}

const { class: className = '', ...props } = Astro.props

const classes = cn(
  'fixed inset-0 z-50 flex items-center justify-center pointer-events-none',
  className
)
---

<div id="achievement-award-overlay" class={classes} {...props}>
  <!-- Backdrop -->
  <div
    id="achievement-award-backdrop"
    class="absolute inset-0 bg-black/70 backdrop-blur-sm opacity-0 transition-opacity duration-500 pointer-events-none"
  >
  </div>

  <!-- Achievement Award Container -->
  <div
    id="achievement-award-container"
    class="relative mx-4 transform scale-75 opacity-0 transition-all duration-700 ease-out pointer-events-auto flex items-center justify-center"
  >
    <!-- Achievement Cards will be rendered here -->
  </div>
</div>

<!-- Achievement Card Template -->
<template id="achievement-card-template">
  <div
    data-card
    class="relative bg-glass-strong rounded-2xl border-2 p-8 text-center shadow-2xl transform transition-all duration-300 hover:scale-105 cursor-pointer w-96 min-h-[480px] flex flex-col"
  >
    <!-- Particle Effects Container -->
    <div data-particles class="absolute inset-0 pointer-events-none"></div>

    <!-- Achievement Content -->
    <div class="relative z-10 flex flex-col h-full">
      <!-- Achievement Icon -->
      <div class="mb-6 flex-shrink-0">
        <div class="relative inline-block">
          <div
            data-icon
            class="text-8xl mb-3 animate-bounce h-20 flex items-center justify-center"
          >
          </div>
          <div data-icon-glow class="absolute inset-0 rounded-full blur-xl opacity-50">
          </div>
        </div>
      </div>

      <!-- Achievement Info -->
      <div class="space-y-3 flex-grow flex flex-col">
        <!-- Achievement Unlocked Text -->
        <div
          class="text-cyan-400 font-orbitron font-bold text-base tracking-wider mb-3 flex-shrink-0"
        >
          üèÜ ACHIEVEMENT UNLOCKED!
        </div>

        <!-- Achievement Name -->
        <h3
          class="font-orbitron font-bold text-2xl text-white mb-3 flex-shrink-0 min-h-[4rem] flex items-center justify-center px-3 leading-tight"
        >
          <span data-name class="line-clamp-2 break-words"></span>
        </h3>

        <!-- Achievement Description -->
        <div class="flex-grow flex items-center justify-center">
          <p
            data-description
            class="text-gray-300 text-base leading-relaxed line-clamp-4 break-words px-3 max-h-24 overflow-hidden"
          >
          </p>
        </div>

        <!-- Rarity Badge -->
        <div class="flex justify-center mt-5 flex-shrink-0">
          <span
            data-rarity-badge
            class="px-4 py-2 rounded-full text-sm font-bold uppercase tracking-wide border min-w-[100px]"
          >
          </span>
        </div>
      </div>

      <!-- Dismiss Instructions -->
      <div class="mt-8 text-sm text-gray-400 opacity-75 flex-shrink-0">
        Click anywhere to continue
      </div>
    </div>

    <!-- Animated Border -->
    <div class="absolute inset-0 rounded-2xl border-2 border-transparent animate-pulse">
      <div data-border class="absolute inset-0 rounded-2xl border-2 opacity-30"></div>
    </div>
  </div>
</template>

<script>
  interface AchievementData {
    id: string
    name: string
    description: string
    icon: string
    rarity: 'common' | 'rare' | 'epic' | 'legendary'
  }

  class AchievementAward {
    private overlay: HTMLElement
    private backdrop: HTMLElement
    private container: HTMLElement
    private template: HTMLTemplateElement
    private queue: AchievementData[] = []
    private isShowing = false

    constructor() {
      this.overlay = document.getElementById('achievement-award-overlay')!
      this.backdrop = document.getElementById('achievement-award-backdrop')!
      this.container = document.getElementById('achievement-award-container')!
      this.template = document.getElementById(
        'achievement-card-template'
      )! as HTMLTemplateElement

      // Hide initially
      this.overlay.style.display = 'none'
    }

    /**
     * Show achievement awards for newly earned achievements
     */
    async showAchievements(achievements: AchievementData[]): Promise<void> {
      if (!achievements || achievements.length === 0) {
        return
      }

      // Add to queue
      this.queue.push(...achievements)

      // Start showing if not already showing
      if (!this.isShowing) {
        await this.processQueue()
      }
    }

    /**
     * Process the achievement queue
     */
    private async processQueue(): Promise<void> {
      if (this.queue.length === 0) {
        this.isShowing = false
        return
      }

      this.isShowing = true

      // Show next achievement
      const achievement = this.queue.shift()!
      await this.showSingleAchievement(achievement)

      // Continue with next achievement after delay
      setTimeout(() => {
        this.processQueue()
      }, 1000)
    }

    /**
     * Show a single achievement
     */
    private async showSingleAchievement(
      achievement: AchievementData
    ): Promise<void> {
      // Create achievement card
      const card = this.createAchievementCard(achievement)

      // Clear container and add new card
      while (this.container.firstChild) {
        this.container.removeChild(this.container.firstChild)
      }
      this.container.appendChild(card)

      // Show overlay
      this.overlay.style.display = 'flex'

      // Animate in
      await this.animateIn()

      // Wait for user interaction or timeout
      await this.waitForDismiss()

      // Animate out
      await this.animateOut()

      // Hide overlay
      this.overlay.style.display = 'none'
    }

    /**
     * Create achievement card element from template
     */
    private createAchievementCard(achievement: AchievementData): HTMLElement {
      const { rarityColor, rarityGlow, particleColor, glowColor } =
        this.getRarityStyles(achievement.rarity)

      // Clone template
      const clone = this.template.content.cloneNode(true) as DocumentFragment
      const card = clone.querySelector('[data-card]') as HTMLElement

      // Apply rarity styles to card
      card.classList.add(...rarityColor.split(' '), ...rarityGlow.split(' '))

      // Populate particles
      const particlesContainer = clone.querySelector(
        '[data-particles]'
      ) as HTMLElement
      this.createParticles(particleColor, particlesContainer)

      // Populate icon
      const iconElement = clone.querySelector('[data-icon]') as HTMLElement
      iconElement.textContent = achievement.icon

      // Apply icon glow
      const iconGlow = clone.querySelector('[data-icon-glow]') as HTMLElement
      iconGlow.classList.add(...glowColor.split(' '))

      // Populate name
      const nameElement = clone.querySelector('[data-name]') as HTMLElement
      nameElement.textContent = achievement.name

      // Populate description
      const descriptionElement = clone.querySelector(
        '[data-description]'
      ) as HTMLElement
      descriptionElement.textContent = achievement.description

      // Populate rarity badge
      const rarityBadge = clone.querySelector(
        '[data-rarity-badge]'
      ) as HTMLElement
      rarityBadge.textContent = achievement.rarity
      rarityBadge.classList.add(
        ...this.getRarityBadgeClass(achievement.rarity).split(' '),
        ...rarityColor.split(' ')
      )

      // Apply border color
      const border = clone.querySelector('[data-border]') as HTMLElement
      border.classList.add(...rarityColor.split(' '))

      // Add click handler
      card.addEventListener('click', () => {
        this.dismissCurrent()
      })

      return card
    }

    /**
     * Get rarity-specific styles
     */
    private getRarityStyles(rarity: string) {
      switch (rarity) {
        case 'legendary':
          return {
            rarityColor: 'border-yellow-400/50',
            rarityGlow: 'shadow-yellow-400/25',
            particleColor: 'rgb(251 191 36)',
            glowColor: 'bg-yellow-400/20',
          }
        case 'epic':
          return {
            rarityColor: 'border-purple-400/50',
            rarityGlow: 'shadow-purple-400/25',
            particleColor: 'rgb(168 85 247)',
            glowColor: 'bg-purple-400/20',
          }
        case 'rare':
          return {
            rarityColor: 'border-blue-400/50',
            rarityGlow: 'shadow-blue-400/25',
            particleColor: 'rgb(59 130 246)',
            glowColor: 'bg-blue-400/20',
          }
        default: // common
          return {
            rarityColor: 'border-gray-400/50',
            rarityGlow: 'shadow-gray-400/25',
            particleColor: 'rgb(156 163 175)',
            glowColor: 'bg-gray-400/20',
          }
      }
    }

    /**
     * Get rarity badge class
     */
    private getRarityBadgeClass(rarity: string): string {
      switch (rarity) {
        case 'legendary':
          return 'bg-yellow-500/20 text-yellow-400'
        case 'epic':
          return 'bg-purple-500/20 text-purple-400'
        case 'rare':
          return 'bg-blue-500/20 text-blue-400'
        default:
          return 'bg-gray-500/20 text-gray-400'
      }
    }

    /**
     * Create particle effects
     */
    private createParticles(color: string, container: HTMLElement): void {
      for (let i = 0; i < 12; i++) {
        const particle = document.createElement('div')
        particle.className = 'absolute w-1 h-1 rounded-full animate-ping'
        particle.style.backgroundColor = color
        particle.style.left = `${Math.random() * 100}%`
        particle.style.top = `${Math.random() * 100}%`
        particle.style.animationDelay = `${Math.random() * 2}s`
        particle.style.animationDuration = `${1 + Math.random() * 1}s`
        particle.style.opacity = `${0.3 + Math.random() * 0.7}`
        container.appendChild(particle)
      }
    }

    /**
     * Animate in
     */
    private async animateIn(): Promise<void> {
      return new Promise(resolve => {
        requestAnimationFrame(() => {
          this.backdrop.style.opacity = '1'
          this.container.style.transform = 'scale(1)'
          this.container.style.opacity = '1'

          // Add entrance sound effect (optional)
          this.playSound('achievement-unlock')

          setTimeout(resolve, 700)
        })
      })
    }

    /**
     * Animate out
     */
    private async animateOut(): Promise<void> {
      return new Promise(resolve => {
        this.backdrop.style.opacity = '0'
        this.container.style.transform = 'scale(0.9)'
        this.container.style.opacity = '0'

        setTimeout(resolve, 500)
      })
    }

    /**
     * Wait for user to dismiss or timeout
     */
    private async waitForDismiss(): Promise<void> {
      return new Promise(resolve => {
        let resolved = false

        const resolveOnce = () => {
          if (!resolved) {
            resolved = true
            resolve()
          }
        }

        // Auto-dismiss after 5 seconds
        const timeout = setTimeout(resolveOnce, 5000)

        // Store dismiss handler
        this.dismissHandler = () => {
          clearTimeout(timeout)
          resolveOnce()
        }
      })
    }

    private dismissHandler: (() => void) | null = null

    /**
     * Dismiss current achievement
     */
    private dismissCurrent(): void {
      if (this.dismissHandler) {
        this.dismissHandler()
        this.dismissHandler = null
      }
    }

    /**
     * Play sound effect (optional)
     */
    private playSound(soundName: string): void {
      // This is optional - you can implement sound effects if desired
      // TODO: Implement sound effects for achievements
    }
  }

  // Global instance
  let achievementAward: AchievementAward

  // Initialize when DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    achievementAward = new AchievementAward()
  })

  // Global function to show achievements
  window.showAchievementAward = function (achievements: AchievementData[]) {
    if (achievementAward) {
      achievementAward.showAchievements(achievements)
    }
  }

  // Add to global scope for TypeScript
  declare global {
    interface Window {
      showAchievementAward: (achievements: AchievementData[]) => void
    }
  }
</script>
