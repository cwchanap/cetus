---
import AppLayout from '@/layouts/AppLayout.astro'
import Container from '@/components/ui/Container.astro'
import Section from '@/components/ui/Section.astro'
import Heading from '@/components/ui/Heading.astro'
import Card from '@/components/ui/Card.astro'
import Button from '@/components/ui/Button.astro'
import Toggle from '@/components/ui/Toggle.astro'
import Slider from '@/components/ui/Slider.astro'
import { getUserPreferences } from '@/lib/server/db/queries'

// Check authentication
const user = Astro.locals.user
if (!user) {
  return Astro.redirect('/login?redirect=/settings')
}

// Fetch server-side notification preferences
const serverPrefs = await getUserPreferences(user.id)
const emailNotifications = serverPrefs?.email_notifications ?? true
const pushNotifications = serverPrefs?.push_notifications ?? false
const challengeReminders = serverPrefs?.challenge_reminders ?? true
---

<AppLayout
  title="Settings - Cetus Gaming Platform"
  description="Manage your preferences and settings on Cetus"
>
  <!-- Animated background -->
  <div class="fixed inset-0 pointer-events-none">
    <div
      class="absolute inset-0 bg-gradient-radial from-cyan-400/20 via-transparent to-transparent animate-pulse"
    >
    </div>
    <div
      class="absolute inset-0 bg-gradient-radial from-purple-400/20 via-transparent to-transparent animate-pulse"
      style="animation-delay: 1s;"
    >
    </div>
  </div>

  <main class="relative z-10 min-h-screen">
    <Section class="py-20">
      <Container class="max-w-3xl">
        <!-- Page Title -->
        <div class="text-center mb-12">
          <Heading level={1} variant="hero" align="center" class="mb-4">
            SETTINGS
          </Heading>
          <p class="text-gray-400 text-lg">Customize your gaming experience</p>
        </div>

        <!-- Sound Settings -->
        <Card variant="glass" class="p-6 md:p-8 mb-6">
          <h3
            class="text-lg font-orbitron font-bold text-cyan-400 mb-6 flex items-center gap-2"
          >
            <span>üîä</span>
            Sound Settings
          </h3>

          <div class="space-y-6">
            <Toggle
              id="sound-enabled"
              name="soundEnabled"
              label="Sound Enabled"
              description="Enable or disable all game sounds"
              checked={true}
              data-pref-type="sound"
              data-pref-key="soundEnabled"
            />

            <div id="volume-controls" class="space-y-4">
              <Slider
                id="master-volume"
                name="masterVolume"
                label="Master Volume"
                min={0}
                max={100}
                step={5}
                value={70}
                unit="%"
                data-pref-type="sound"
                data-pref-key="masterVolume"
              />

              <Slider
                id="sfx-volume"
                name="sfxVolume"
                label="Sound Effects"
                min={0}
                max={100}
                step={5}
                value={80}
                unit="%"
                data-pref-type="sound"
                data-pref-key="sfxVolume"
              />

              <Slider
                id="music-volume"
                name="musicVolume"
                label="Music"
                min={0}
                max={100}
                step={5}
                value={60}
                unit="%"
                data-pref-type="sound"
                data-pref-key="musicVolume"
              />
            </div>
          </div>
        </Card>

        <!-- Display Settings -->
        <Card variant="glass" class="p-6 md:p-8 mb-6">
          <h3
            class="text-lg font-orbitron font-bold text-cyan-400 mb-6 flex items-center gap-2"
          >
            <span>üé®</span>
            Display Settings
          </h3>

          <div class="space-y-4">
            <Toggle
              id="reduced-motion"
              name="reducedMotion"
              label="Reduced Motion"
              description="Minimize animations for better accessibility"
              data-pref-type="display"
              data-pref-key="reducedMotion"
            />

            <Toggle
              id="dark-mode"
              name="darkMode"
              label="Dark Mode"
              description="Toggle between light and dark themes"
              checked={true}
              data-pref-type="display"
              data-pref-key="theme"
            />
          </div>
        </Card>

        <!-- Notification Settings -->
        <Card variant="glass" class="p-6 md:p-8 mb-6">
          <h3
            class="text-lg font-orbitron font-bold text-cyan-400 mb-6 flex items-center gap-2"
          >
            <span>üîî</span>
            Notification Settings
          </h3>

          <div class="space-y-4">
            <Toggle
              id="email-notifications"
              name="emailNotifications"
              label="Email Notifications"
              description="Receive updates and reminders via email"
              checked={emailNotifications}
              data-server-pref="email_notifications"
            />

            <Toggle
              id="push-notifications"
              name="pushNotifications"
              label="Push Notifications"
              description="Receive browser push notifications"
              checked={pushNotifications}
              data-server-pref="push_notifications"
            />

            <Toggle
              id="challenge-reminders"
              name="challengeReminders"
              label="Daily Challenge Reminders"
              description="Get reminded about incomplete daily challenges"
              checked={challengeReminders}
              data-server-pref="challenge_reminders"
            />
          </div>
        </Card>

        <!-- Account Settings -->
        <Card variant="glass" class="p-6 md:p-8 mb-6">
          <h3
            class="text-lg font-orbitron font-bold text-cyan-400 mb-6 flex items-center gap-2"
          >
            <span>üë§</span>
            Account Settings
          </h3>

          <div class="space-y-4">
            <a href="/profile" class="block">
              <Button variant="outline" size="lg" class="w-full justify-center">
                <span class="flex items-center gap-2">
                  <span>‚úèÔ∏è</span>
                  Edit Profile
                </span>
              </Button>
            </a>

            <!-- Password Change Section -->
            <div
              class="border-t border-gray-200/60 dark:border-gray-700/50 pt-4"
            >
              <Button
                variant="outline"
                size="lg"
                class="w-full justify-center"
                id="change-password-btn"
              >
                <span class="flex items-center gap-2">
                  <span>üîë</span>
                  Change Password
                </span>
              </Button>

              <!-- Password Change Form (hidden by default) -->
              <div id="password-change-form" class="hidden mt-4 space-y-4">
                <div>
                  <label
                    for="current-password"
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                  >
                    Current Password
                  </label>
                  <div class="relative">
                    <input
                      type="password"
                      id="current-password"
                      class="w-full px-4 py-3 rounded-lg border bg-background border-input text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-cyan-400/50 focus:border-cyan-400/50 pr-12 transition-colors"
                      placeholder="Enter current password"
                      autocomplete="current-password"
                    />
                    <button
                      type="button"
                      class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"
                      data-toggle-password="current-password"
                      aria-label="Show password"
                    >
                      üëÅÔ∏è
                    </button>
                  </div>
                </div>

                <div>
                  <label
                    for="new-password"
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                  >
                    New Password
                  </label>
                  <div class="relative">
                    <input
                      type="password"
                      id="new-password"
                      class="w-full px-4 py-3 rounded-lg border bg-background border-input text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-cyan-400/50 focus:border-cyan-400/50 pr-12 transition-colors"
                      placeholder="Enter new password (min 8 characters)"
                      autocomplete="new-password"
                      minlength="8"
                    />
                    <button
                      type="button"
                      class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"
                      data-toggle-password="new-password"
                      aria-label="Show password"
                    >
                      üëÅÔ∏è
                    </button>
                  </div>
                </div>

                <div>
                  <label
                    for="confirm-password"
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                  >
                    Confirm New Password
                  </label>
                  <div class="relative">
                    <input
                      type="password"
                      id="confirm-password"
                      class="w-full px-4 py-3 rounded-lg border bg-background border-input text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-cyan-400/50 focus:border-cyan-400/50 pr-12 transition-colors"
                      placeholder="Confirm new password"
                      autocomplete="new-password"
                      minlength="8"
                    />
                    <button
                      type="button"
                      class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"
                      data-toggle-password="confirm-password"
                      aria-label="Show password"
                    >
                      üëÅÔ∏è
                    </button>
                  </div>
                </div>

                <div
                  id="password-error"
                  class="hidden text-destructive text-sm"
                >
                </div>

                <div class="flex gap-3">
                  <Button
                    variant="primary"
                    size="lg"
                    class="flex-1 justify-center"
                    id="save-password-btn"
                  >
                    Save Password
                  </Button>
                  <Button
                    variant="outline"
                    size="lg"
                    class="justify-center"
                    id="cancel-password-btn"
                  >
                    Cancel
                  </Button>
                </div>
              </div>
            </div>

            <Button
              variant="destructive"
              size="lg"
              class="w-full justify-center"
              id="delete-account-btn"
              disabled
              title="Account deletion not yet available - Please contact support"
            >
              <span class="flex items-center gap-2">
                <span>‚ö†Ô∏è</span>
                Delete Account (Unavailable)
              </span>
            </Button>
          </div>
        </Card>

        <!-- Back to Dashboard -->
        <div class="text-center">
          <a href="/dashboard" class="text-cyan-400 hover:underline">
            ‚Üê Back to Dashboard
          </a>
        </div>
      </Container>
    </Section>
  </main>

  <!-- Save Status Toast -->
  <div
    id="save-status"
    role="status"
    aria-live="polite"
    aria-atomic="true"
    aria-hidden="true"
    class="fixed bottom-4 right-4 z-50 px-4 py-2 rounded-lg text-white font-medium transition-all transform translate-y-20 opacity-0"
  >
    Settings saved!
  </div>
</AppLayout>

<script>
  import {
    getClientPreferences,
    saveClientPreferences,
    updateSoundPreference,
    type ClientPreferences,
    resolveTheme,
  } from '@/lib/preferences'
  import { authClient } from '@/lib/auth-client'

  // Initialize on DOM ready
  document.addEventListener('DOMContentLoaded', () => {
    const prefs = getClientPreferences()

    // Initialize sound settings from localStorage
    initializeSoundSettings(prefs)

    // Initialize display settings from localStorage
    initializeDisplaySettings(prefs)

    // Set up event listeners for client-side preferences
    setupClientPreferenceListeners()

    // Set up event listeners for server-side preferences
    setupServerPreferenceListeners()

    // Set up password change listeners
    setupPasswordChangeListeners()
  })

  function initializeSoundSettings(prefs: ClientPreferences) {
    // Sound enabled toggle - always update to match stored preference
    const soundToggle = document.getElementById('sound-enabled')
    if (soundToggle) {
      const button = soundToggle.closest('[data-toggle]') as HTMLButtonElement
      if (button) {
        const currentChecked = button.getAttribute('aria-checked') === 'true'
        if (currentChecked !== prefs.sound.soundEnabled) {
          button.click()
        }
      }
    }

    // Volume sliders - set initial values via the component
    setSliderValue('master-volume', prefs.sound.masterVolume)
    setSliderValue('sfx-volume', prefs.sound.sfxVolume)
    setSliderValue('music-volume', prefs.sound.musicVolume)

    // Update volume controls visibility based on sound enabled
    updateVolumeControlsVisibility(prefs.sound.soundEnabled)
  }

  function initializeDisplaySettings(prefs: ClientPreferences) {
    // Apply reduced motion class from stored preferences on load
    if (prefs.display.reducedMotion) {
      document.documentElement.classList.add('reduce-motion')
    } else {
      document.documentElement.classList.remove('reduce-motion')
    }

    // Update reduced motion toggle to match stored preference
    const motionToggleContainer = document
      .getElementById('reduced-motion')
      ?.closest('[data-toggle]') as HTMLElement & {
      toggleComponent?: { setChecked: (v: boolean) => void }
    }
    if (motionToggleContainer?.toggleComponent) {
      // Use Toggle component's API to properly sync state
      motionToggleContainer.toggleComponent.setChecked(
        prefs.display.reducedMotion
      )
    }

    // Apply theme from stored preferences
    const resolvedTheme = resolveTheme(prefs.display.theme)
    document.documentElement.classList.remove('dark', 'light')
    if (resolvedTheme === 'dark') {
      document.documentElement.classList.add('dark')
    }

    // Update dark mode toggle to match stored preference (true = dark mode)
    const themeToggleContainer = document
      .getElementById('dark-mode')
      ?.closest('[data-toggle]') as HTMLElement & {
      toggleComponent?: { setChecked: (v: boolean) => void }
    }
    if (themeToggleContainer?.toggleComponent) {
      themeToggleContainer.toggleComponent.setChecked(resolvedTheme === 'dark')
    }
  }

  function setSliderValue(id: string, value: number) {
    const container = document
      .getElementById(id)
      ?.closest('[data-slider-container]') as HTMLElement & {
      sliderComponent?: { setValueExternal: (v: number) => void }
    }
    if (container?.sliderComponent) {
      container.sliderComponent.setValueExternal(value)
    }
  }

  function updateVolumeControlsVisibility(enabled: boolean) {
    const volumeControls = document.getElementById('volume-controls')
    if (volumeControls) {
      volumeControls.style.opacity = enabled ? '1' : '0.5'
      volumeControls.style.pointerEvents = enabled ? 'auto' : 'none'
    }
  }

  function setupClientPreferenceListeners() {
    // Sound enabled toggle
    const soundToggleContainer = document
      .getElementById('sound-enabled')
      ?.closest('[data-toggle]')
    if (soundToggleContainer) {
      soundToggleContainer.addEventListener('toggle-change', (e: Event) => {
        const detail = (e as CustomEvent).detail
        const prefs = getClientPreferences()
        prefs.sound.soundEnabled = detail.checked
        saveClientPreferences(prefs)
        updateVolumeControlsVisibility(detail.checked)
        showSaveStatus()
      })
    }

    // Volume sliders
    ;['master-volume', 'sfx-volume', 'music-volume'].forEach(id => {
      const container = document
        .getElementById(id)
        ?.closest('[data-slider-container]')
      if (container) {
        container.addEventListener('slider-change', (e: Event) => {
          const detail = (e as CustomEvent).detail
          const key = container.getAttribute(
            'data-pref-key'
          ) as keyof ClientPreferences['sound']

          if (key) {
            updateSoundPreference(key, detail.value as never)
            showSaveStatus()
          }
        })
      }
    })

    // Reduced motion toggle
    const motionToggleContainer = document
      .getElementById('reduced-motion')
      ?.closest('[data-toggle]')
    if (motionToggleContainer) {
      motionToggleContainer.addEventListener('toggle-change', (e: Event) => {
        const detail = (e as CustomEvent).detail
        const prefs = getClientPreferences()
        prefs.display.reducedMotion = detail.checked
        saveClientPreferences(prefs)

        // Apply reduced motion to document
        if (detail.checked) {
          document.documentElement.classList.add('reduce-motion')
        } else {
          document.documentElement.classList.remove('reduce-motion')
        }

        showSaveStatus()
      })
    }

    // Dark mode toggle
    const themeToggleContainer = document
      .getElementById('dark-mode')
      ?.closest('[data-toggle]')
    if (themeToggleContainer) {
      themeToggleContainer.addEventListener('toggle-change', (e: Event) => {
        const detail = (e as CustomEvent).detail
        const newTheme = detail.checked ? 'dark' : 'light'

        // Update preferences
        const prefs = getClientPreferences()
        prefs.display.theme = newTheme
        saveClientPreferences(prefs)

        // Apply theme immediately
        document.documentElement.classList.remove('dark', 'light')
        if (newTheme === 'dark') {
          document.documentElement.classList.add('dark')
        }

        showSaveStatus()
      })
    }
  }

  function setupServerPreferenceListeners() {
    // Find all server preference toggles
    document.querySelectorAll('[data-server-pref]').forEach(container => {
      const toggle = container.closest('[data-toggle]')
      if (!toggle) {
        return
      }

      // Guard flag to prevent handler re-entry during revert
      let ignoreRevert = false

      toggle.addEventListener('toggle-change', async (e: Event) => {
        // Exit early if we're in a revert operation
        if (ignoreRevert) {
          return
        }

        const detail = (e as CustomEvent).detail
        const prefKey = container.getAttribute('data-server-pref')

        if (!prefKey) {
          return
        }

        try {
          const response = await fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ [prefKey]: detail.checked }),
          })

          // Check response.ok before parsing JSON
          if (!response.ok) {
            const errorText = await response.text()
            console.error(
              `Failed to save preference (${response.status}): ${errorText}`
            )
            showSaveStatus(`Failed to save (${response.status})`, 'error')
            // Revert toggle with guard to prevent handler re-entry
            ignoreRevert = true
            const button = toggle as HTMLButtonElement
            button.click()
            queueMicrotask(() => {
              ignoreRevert = false
            })
            return
          }

          // Try to parse JSON response
          let result: { success: boolean }
          try {
            result = await response.json()
          } catch (parseError) {
            console.error('Failed to parse response JSON:', parseError)
            showSaveStatus('Invalid response from server', 'error')
            // Revert toggle with guard to prevent handler re-entry
            ignoreRevert = true
            const button = toggle as HTMLButtonElement
            button.click()
            queueMicrotask(() => {
              ignoreRevert = false
            })
            return
          }

          if (result.success) {
            showSaveStatus('Saved!', 'success')
          } else {
            showSaveStatus('Failed to save', 'error')
            // Revert toggle with guard to prevent handler re-entry
            ignoreRevert = true
            const button = toggle as HTMLButtonElement
            button.click()
            queueMicrotask(() => {
              ignoreRevert = false
            })
          }
        } catch (error) {
          console.error('Failed to save preference:', error)
          showSaveStatus('Network error', 'error')
          // Revert toggle with guard to prevent handler re-entry
          ignoreRevert = true
          const button = toggle as HTMLButtonElement
          button.click()
          queueMicrotask(() => {
            ignoreRevert = false
          })
        }
      })
    })
  }

  function showSaveStatus(
    message: string = 'Saved!',
    type: 'success' | 'error' = 'success'
  ) {
    const status = document.getElementById('save-status')
    if (!status) {
      return
    }

    status.textContent = message
    status.setAttribute('aria-label', message)
    status.setAttribute('aria-hidden', 'false')
    status.className = `fixed bottom-4 right-4 z-50 px-4 py-2 rounded-lg text-white font-medium transition-all transform ${
      type === 'error' ? 'bg-red-500' : 'bg-green-500'
    }`

    // Animate in
    requestAnimationFrame(() => {
      status.style.transform = 'translateY(0)'
      status.style.opacity = '1'
    })

    // Animate out after delay
    setTimeout(() => {
      status.style.transform = 'translateY(20px)'
      status.style.opacity = '0'
      status.setAttribute('aria-hidden', 'true')
    }, 2000)
  }

  function setupPasswordChangeListeners() {
    const changePasswordBtn = document.getElementById('change-password-btn')
    const passwordForm = document.getElementById('password-change-form')
    const cancelPasswordBtn = document.getElementById('cancel-password-btn')
    const savePasswordBtn = document.getElementById('save-password-btn')
    const currentPasswordInput = document.getElementById(
      'current-password'
    ) as HTMLInputElement
    const newPasswordInput = document.getElementById(
      'new-password'
    ) as HTMLInputElement
    const confirmPasswordInput = document.getElementById(
      'confirm-password'
    ) as HTMLInputElement
    const passwordError = document.getElementById('password-error')

    // Toggle password visibility buttons
    document.querySelectorAll('[data-toggle-password]').forEach(btn => {
      btn.addEventListener('click', () => {
        const targetId = btn.getAttribute('data-toggle-password')
        if (!targetId) {
          return
        }
        const input = document.getElementById(targetId) as HTMLInputElement
        if (input) {
          const isPassword = input.type === 'password'
          input.type = isPassword ? 'text' : 'password'
          const button = btn as HTMLButtonElement
          button.textContent = isPassword ? 'üôà' : 'üëÅÔ∏è'
          button.setAttribute(
            'aria-label',
            isPassword ? 'Hide password' : 'Show password'
          )
        }
      })
    })

    // Show password form
    changePasswordBtn?.addEventListener('click', () => {
      passwordForm?.classList.remove('hidden')
      changePasswordBtn.classList.add('hidden')
      currentPasswordInput?.focus()
    })

    // Cancel password change
    cancelPasswordBtn?.addEventListener('click', () => {
      hidePasswordForm()
    })

    // Save password
    savePasswordBtn?.addEventListener('click', async () => {
      // Clear previous errors
      if (passwordError) {
        passwordError.classList.add('hidden')
        passwordError.textContent = ''
      }

      const currentPassword = currentPasswordInput?.value || ''
      const newPassword = newPasswordInput?.value || ''
      const confirmPassword = confirmPasswordInput?.value || ''

      // Validation
      if (!currentPassword) {
        showPasswordError('Please enter your current password')
        return
      }

      if (!newPassword) {
        showPasswordError('Please enter a new password')
        return
      }

      if (newPassword.length < 8) {
        showPasswordError('New password must be at least 8 characters')
        return
      }

      if (newPassword !== confirmPassword) {
        showPasswordError('New passwords do not match')
        return
      }

      // Disable button and show loading
      if (savePasswordBtn) {
        savePasswordBtn.setAttribute('disabled', 'true')
        savePasswordBtn.textContent = '‚è≥ Saving...'
      }

      try {
        const { error } = await authClient.changePassword({
          currentPassword,
          newPassword,
          revokeOtherSessions: true,
        })

        if (error) {
          // Handle specific error messages
          const errorMessage =
            error.message || 'Failed to change password. Please try again.'
          if (
            errorMessage.toLowerCase().includes('incorrect') ||
            errorMessage.toLowerCase().includes('invalid') ||
            errorMessage.toLowerCase().includes('wrong')
          ) {
            showPasswordError('Current password is incorrect')
          } else {
            showPasswordError(errorMessage)
          }
          return
        }

        // Success
        showSaveStatus('Password changed successfully!', 'success')
        hidePasswordForm()
      } catch (err) {
        console.error('Password change error:', err)
        showPasswordError('Network error. Please try again.')
      } finally {
        // Re-enable button
        if (savePasswordBtn) {
          savePasswordBtn.removeAttribute('disabled')
          savePasswordBtn.textContent = 'Save Password'
        }
      }
    })

    function showPasswordError(message: string) {
      if (passwordError) {
        passwordError.textContent = message
        passwordError.classList.remove('hidden')
      }
    }

    function hidePasswordForm() {
      passwordForm?.classList.add('hidden')
      changePasswordBtn?.classList.remove('hidden')
      // Clear inputs
      if (currentPasswordInput) {
        currentPasswordInput.value = ''
      }
      if (newPasswordInput) {
        newPasswordInput.value = ''
      }
      if (confirmPasswordInput) {
        confirmPasswordInput.value = ''
      }
      // Clear error
      if (passwordError) {
        passwordError.classList.add('hidden')
        passwordError.textContent = ''
      }
      // Reset password visibility
      document.querySelectorAll('[data-toggle-password]').forEach(btn => {
        const targetId = btn.getAttribute('data-toggle-password')
        if (targetId) {
          const input = document.getElementById(targetId) as HTMLInputElement
          if (input) {
            input.type = 'password'
          }
          const button = btn as HTMLButtonElement
          button.textContent = 'üëÅÔ∏è'
          button.setAttribute('aria-label', 'Show password')
        }
      })
    }
  }
</script>

<style>
  /* Reduced motion styles */
  :global(.reduce-motion *) {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
</style>
